<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta http-equiv="Cache-control" content="no-cache">
  <title>Document</title>
  <!-- <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mui/3.7.1/css/mui.min.css"
    integrity="sha512-uclHupzhjfJ5Zbsweb6eEK3HyTUpSfiWq/+ORo20uQLZg3yI5Jg4iCZYOD5Q1Q5Ftm4FG9kCzwT82bVcNgFMRw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mui/3.7.1/js/mui.min.js"
    integrity="sha512-5LSZkoyayM01bXhnlp2T6+RLFc+dE4SIZofQMxy/ydOs3D35mgQYf6THIQrwIMmgoyjI+bqjuuj4fQcGLyJFYg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->

  <!-- <script src="https://metaverse-webar.oss-cn-hangzhou.aliyuncs.com/pro/PluginRepositories/permissions.js"></script> -->
  <!-- <script src="https://metaverse-webar.oss-cn-hangzhou.aliyuncs.com/pro/permissionsApi.js"></script> -->
  <script src="https://metaverse-webar.oss-cn-hangzhou.aliyuncs.com/pro/8thwall.js"></script>
  <!-- <script src="../../webAr/asd/immersal/8thwall.js"></script> -->
  <!-- <script src="../../webAr/asd/immersal/permissionsApi.js"></script> -->
  <style>

  </style>
</head>

<body>
  <!-- <video width="500" height="500" autoplay class="video"></video> -->
  <canvas id="camerafeed"></canvas>
  <button onclick="checkAuthorization()">检查权限</button>
  <button onclick="close()">关闭摄像头</button>
  <button onclick="opens()" type="button">打开摄像头</button>

  <button onclick="removeCameraPipelineModules()">移除相机管道</button>
  <button onclick="addCameraPipelineModules()">添加相机管道</button>
  <button onclick="recognition()">识别</button>

  <script>
    let permissionsObj;
    function startCompassListener(callback) {
      if (!window["DeviceOrientationEvent"]) {
        console.warn("DeviceOrientation API not available");
        return;
      }
      let absoluteListener = (e) => {
        if (!e.absolute || e.alpha == null || e.beta == null || e.gamma == null)
          return;
        let compass = -(e.alpha + e.beta * e.gamma / 90);
        compass -= Math.floor(compass / 360) * 360; // Wrap into range [0,360].
        window.removeEventListener("deviceorientation", webkitListener);
        callback(compass);
      };
      let webkitListener = (e) => {
        let compass = e.webkitCompassHeading;
        if (compass != null && !isNaN(compass)) {
          callback(compass);
          window.removeEventListener("deviceorientationabsolute", absoluteListener);
        }
      }

      function addListeners() {
        window.addEventListener("deviceorientationabsolute", absoluteListener);
        window.addEventListener("deviceorientation", webkitListener);
      }

      if (typeof (DeviceOrientationEvent["requestPermission"]) === "function") {
        DeviceOrientationEvent["requestPermission"]()
          .then(response => {
            if (response == "granted") {
              addListeners();
            } else
              console.warn("Permission for DeviceMotionEvent not granted");
          });
      } else
        addListeners();
    }

    function startWatchPosition(callback) {
      if ("geolocation" in navigator) {
        // 支持Geolocation
        navigator.geolocation.watchPosition(function (position) {
          // 成功获取位置信息
          const latitude = position.coords.latitude; // 纬度
          const longitude = position.coords.longitude; // 经度
          const altitude = position.coords.altitude; // 高度
          const speed = position.coords.speed; // 速度
          const heading = position.coords.heading; // 方向
          callback(position)
        }, function (error) {
          // 获取位置信息失败
          console.error("获取位置信息失败：" + error.message);
        }, { enableHighAccuracy: true, maximumAge: 0 });
      } else {
        // 不支持Geolocation
        console.error("浏览器不支持Geolocation API");
      }
    }

    function checkAuthorization() {
      permissionsObj.checkAuthorization((authorizationResult) => {
        console.log("authorizationResult", authorizationResult);
      })
    }

    function opens() {
      permissionsObj.onStartCamera();
    }

    function close() {
      permissionsObj.onCloseCamera();
    }

    function removeCameraPipelineModules() {
      if (XR8.isInitialized()) {
        xr8.removeImmersalPipelineModules();
        console.log(XR8.version());
      }
    }

    function addCameraPipelineModules() {
      if (XR8.isInitialized()) {
        xr8.injectImmersalPipelineModule();
        console.log(XR8.version())
      }
    }

    function recognition() {
      if (XR8.isInitialized()) {
        xr8.recognition((success, position, rotation, scale) => {
          if (success) {
            console.log("recognition：", position, rotation, scale);
          }
        });
        console.log(XR8.version())
      }
    }

    // window.onload = () => {
    // new window.VConsole();
    // console.log("permissions", new permissions());

    // permissionsObj = new permissions.init({
    //   // loadJSOrCSS:[]        // Need Loader JS Or CSS 
    //   unityInstance: {        // *SendMessage Target
    //     target: {},
    //     sendMessage: {
    //       gameObject: "UnityJsBridge",
    //       methodName: "JsToUnityTrigger",
    //       timer: 1000,
    //     }
    //   },
    //   permissions: {
    //     deviceorientation: {
    //       enabled: false,
    //       successResults: (response) => { }
    //     },
    //     geolocation: {
    //       enabled: false,
    //       successResults: (response) => { }
    //     },
    //     mediaDevices: {
    //       enabled: false,
    //       canvas: "cameraCanvas",
    //       successResults: (response) => { },
    //       video: {
    //         width: 1280,
    //         height: 720,
    //         // frameRate: { ideal: 10, max: 15 },
    //         facingMode: { exact: "environment" },
    //       },
    //       audio: false,
    //     }
    //   },
    //   deviceAuthorization: {
    //     confirm: {
    //       message: "《AR导航》需要访问您的摄像头、运动与方向，需要您的授权！",
    //       title: "提示",
    //       btnValue: ['取消', '允许'],
    //       callback: ({ index, value: { authorization, btnName } }) => { },
    //       type: "div"
    //     },
    //     alert: {
    //       message: "请使用安卓或苹果设备访问！",
    //       title: "提示",
    //       btnValue: ["确定"],
    //       callback: ({ index, value: { inform, btnName } }) => { },
    //       type: "div"
    //     }
    //   },
    //   errors: ({ index, value: { error, btnName = "" } }) => {
    //     console.log("errors", error,);
    //   },
    //   debugger: true,
    // }, ({ success }) => {
    //   console.log("success, age", success)
    //   if (success) {




    //     // setInterval(() => {
    //     //   if (this._useCan && this._unityInstance?.target) {
    //     //     this._unityInstance.target.SendMessage(this._unityInstance.sendMessage.gameObject, this._unityInstance.sendMessage.methodName, JSON.stringify(this._compassAndLocation));
    //     //   }
    //     // }, this._unityInstance.sendMessage.timer);
    //   }
    // });


    let xr8 = new xr8thWall.Init({
      appKey: "1JQhYDLd1E7p8jnKth96BNIyfd0zRIqfMejyXzj0shJjcFMiSIybdWPFDzGq95nagyx2ri",
      cameraConfig: {
        enabled: true,
        canvas: "camerafeed",
        onUpdate: ({ cameraPosition, cameraRotation }) => {
          console.log("onUpdate", cameraPosition, cameraRotation);
        }
      },
      debugger: true,
    }, ({ success, errors = null }) => {
      if (success) {
        console.log("xr8thWall", success, errors, XR8, xr8);
      }
    }, ({ message }) => {
      console.log("message", message);
    })







    // var u = navigator.userAgent;
    // if (u.indexOf('Android') > -1 || u.indexOf('Linux') > -1 || u.indexOf('Windows Phone') > -1) {
    //   startCompassListener(res => {
    //     if (res) {
    //       console.log("startCompassListener", res);
    //     }
    //   })
    //   startWatchPosition(res => {
    //     if (res) {
    //       console.log("startWatchPosition", res);
    //     }
    //   })
    // } else if (u.indexOf('iPhone') > -1) {
    //   mui.confirm(`"${window.location.href}"想要访问运动与方向`, '提示', ['取消', '允许'], (res) => {
    //     console.log("IOS mui", res);
    //     startCompassListener(res => {
    //       if (res) {
    //         console.log("IOS startCompassListener", res);
    //       }
    //     })
    //     startWatchPosition(position => {
    //       if (position) {
    //         let latitude = position.coords.latitude; // 纬度
    //         let longitude = position.coords.longitude; // 经度
    //         let altitude = position.coords.altitude; // 高度
    //         let speed = position.coords.speed; // 速度
    //         let heading = position.coords.heading; // 方向
    //         console.log("IOS startWatchPosition", `latitude：${latitude},longitude:${longitude}`);
    //       }
    //     })
    //   }, 'div')
    // } else {
    //   return 'noAndoIos'
    // }

    // }
  </script>
</body>

</html>