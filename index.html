<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>当前方位获取</title>
    <meta name="viewport" content="initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <style type="text/css">
        * {
            margin: auto;
            background-color: #000000;
            color: #ffffff;
        }

        .info {
            width: 100%;
            height: 30px;
            bottom: 12.5rem;
            position: fixed;
            text-align: center;
        }

        #compas {
            font-size: 3.75rem;
        }

        .pos {
            display: flex;
            text-align: -webkit-center;
            margin-top: 1rem;
        }

        #position {
            width: 100%;
            height: 30px;
            font-size: 1.75rem;
            margin-top: 0.75rem;
        }
    </style>
</head>

<body>
    <!-- 仪表盘 -->
    <div id="compass"></div>
    <div class="info">
        <!-- 方位信息展示 -->
        <div id="compas"></div>
        <!-- 位置信息展示 -->
        <div class="pos">
            <div id="lng"></div>
            <div id="lat"></div>
        </div>
        <div id="position"></div>
        <button onclick="get()">授权</button>
    </div>

    <div id="allmap"></div>

    <!-- 指南针js -->
    <script type="text/javascript" src="./assets/dist/js/jquery.min.js"></script>
    <script type="text/javascript" src="./assets/dist/js/raphael.js"></script>
    <script type="text/javascript" src="./assets/dist/js/hammer.min.js"></script>
    <!-- 地图js文件 -->
    <script type="text/javascript"
        src="https://api.map.baidu.com/api?v=2.0&ak=KF1NL2LiIp9kwE0Uf3PYHC7G2NNfuLtd"></script>

    <script>
        new window.VConsole();
        //计算屏幕宽度 高度
        var pageWidth = window.innerWidth;
        var pageHeight = window.innerHeight;
        if (typeof pageWidth != "number") {
            if (document.compatMode == "CSS1Compat") {
                pageWidth = document.documentElement.clientWidth;
                pageHeight = document.documentElement.clientHeight;
            } else {
                pageWidth = document.body.clientWidth;
                pageHeight = document.body.clientHeight;
            }
        }
        var zoom = 1;
        //compass div 宽高
        var paperWidth = 300;
        var paperHeight = 300;
        var crLong = 130 * zoom;
        var crShort = 100 * zoom;
        var cdiff = paperHeight / 2 - crLong;
        var initX = (pageWidth - paperWidth) > 0 ? (pageWidth - paperWidth) / 2 : 0;
        var initY = (pageHeight - paperHeight) > 0 ? (pageHeight - paperHeight) / 4 : 0;
        // document.getElementById("compass").style.marginTop = initY + "px";
        // document.getElementById("compass").style.marginLeft = initX + "px";

        //创建画布
        var compassPaper = Raphael(initX, initY, paperWidth, paperHeight)
        //画圆
        compassPaper.circle(paperWidth / 2, paperHeight / 2, crLong).attr('fill', 'black');

        var cross = compassPaper.set()
        var crossStyle = {
            stroke: 'white',
            'stroke-width': 1
        }
        //指南针画十字
        var pathlineX = 'M' + (paperWidth / 2 - crShort / 2) + ' ' + (paperHeight / 2) + 'L' + (paperWidth / 2 + crShort / 2) + ' ' + (paperHeight / 2);
        var pathlineY = 'M' + (paperWidth / 2) + ' ' + (paperHeight / 2 - crShort / 2) + 'L' + (paperWidth / 2) + ' ' + (paperHeight / 2 + crShort / 2);
        var northline = 'M' + (paperWidth / 2) + ' ' + (paperHeight / 2 - crShort) + 'L' + (paperWidth / 2) + ' ' + (crLong - crShort);

        cross.push(
            compassPaper.path(pathlineX).attr(crossStyle),
            compassPaper.path(pathlineY).attr(crossStyle)
        )
        //指北线
        var northBar = compassPaper.path(northline).attr({
            stroke: 'white',
            'stroke-width': 4
        })
        var compass = compassPaper.set()
        var strokeWidth
        var billet
        var degText
        for (var i = 0; i < 360; i = i + 2) {
            if (i % 30 == 0) {
                strokeWidth = 2
                degText = compassPaper.text(paperWidth / 2, (paperHeight / 2 - crShort) * 4 / 5, i).attr({
                    fill: 'white',
                    'font-size': '16rem'
                }).transform('R' + i + ', ' + paperWidth / 2 + ', ' + paperHeight / 2)
                degText.degPosition = i
                compass.push(degText)
            } else {
                strokeWidth = 1
            }
            billet = compassPaper.path('M' + paperWidth / 2 + ' ' + (paperHeight / 2 - crShort) + 'L' + paperWidth / 2 + '  ' + (paperHeight / 2 - crShort + crShort / 5)).attr({
                stroke: 'white',
                'stroke-width': strokeWidth
            }).transform('R' + i + ',' + paperWidth / 2 + ', ' + paperHeight / 2)
            billet.degPosition = i
            compass.push(
                billet
            );
        }
        ['北', '东', '南', '西'].forEach(function (direction, index) {
            var directionText = compassPaper.text(paperWidth / 2, (paperHeight / 2 - crShort + crShort / 3), direction).attr({
                fill: 'white',
                'font-size': '20rem'
            }).transform('R' + index * 90 + ', ' + (paperWidth / 2) + ',' + paperHeight / 2)
            directionText.degPosition = index * 90
            compass.push(directionText)
        })

        var redTriLine = 'M' + (paperWidth / 2) + ' ' + ((paperHeight / 2 - crLong) + cdiff / 2) + ' L' + (paperWidth / 2 - (paperHeight / 2 - crShort) / 4) + ' ' + (paperHeight / 2 - crShort) + ' L' + (paperWidth / 2 + (paperHeight / 2 - crShort) / 4) + ' ' + (paperHeight / 2 - crShort) + 'Z';
        var redTriangle = compassPaper.path(redTriLine).attr({
            fill: 'red',
            'stroke-width': 0
        })
        redTriangle.degPosition = 0
        compass.push(redTriangle)

        var alphaText = compassPaper.text((paperWidth / 2), 440, '0°').attr({
            fill: 'white',
            'font-size': '30rem'
        })

        function throttle(method, delay, duration) {
            console.log("throttlethrottlethrottlethrottle", method, delay, duration);
            var timer = null,
                begin = new Date();
            return function () {
                var context = this,
                    args = arguments,
                    current = new Date();;
                clearTimeout(timer);
                if (current - begin >= duration) {
                    method.apply(context, args);
                    begin = current;
                } else {
                    timer = setTimeout(function () {
                        method.apply(context, args);
                    }, delay);
                }
            }
        }

        function deviceOrientationListener(event) {

            var alpha = event.webkitCompassHeading || event.alpha;
            console.log("event.webkitCompassHeading || event.alpha", event.webkitCompassHeading, "event.alpha", event.alpha);
            alphaText.attr({
                text: parseInt(alpha) + '°'
            });
            var directionIndex;
            var pos;
            if (alpha > 337.5 || alpha < 22.5) {
                directionIndex = 0;
                pos = "北";
            } else if (alpha > 45 - 22.5 && alpha < 45 + 22.5) {
                directionIndex = 1;
                pos = "东北";
            } else if (alpha > 90 - 22.5 && alpha < 90 + 22.5) {
                directionIndex = 2;
                pos = "东";
            } else if (alpha > 135 - 22.5 && alpha < 135 + 22.5) {
                directionIndex = 3;
                pos = "东南";
            } else if (alpha > 180 - 22.5 && alpha < 180 + 22.5) {
                directionIndex = 4;
                pos = "南";
            } else if (alpha > 225 - 22.5 && alpha < 225 + 22.5) {
                directionIndex = 5;
                pos = "西南";
            } else if (alpha > 270 - 22.5 && alpha < 270 + 22.5) {
                directionIndex = 6;
                pos = "西";
            } else if (alpha > 315 - 22.5 && alpha < 315 + 22.5) {
                directionIndex = 7;
                pos = "西北";
            }
            var cos = document.getElementById("compas");
            compass.forEach(function (item) {
                item.transform('R' + (item.degPosition - alpha) + ',' + (paperWidth / 2) + ', ' + paperHeight / 2)
            })
            cos.innerHTML = parseInt(alpha) + '°' + pos
        }

        function get() {
            console.log("getgetgetgetgetgetgetgetgetgetgetgetgetget");
            var u = navigator.userAgent;
            if (u.indexOf('Android') > -1 || u.indexOf('Linux') > -1 || u.indexOf('Windows Phone') > -1) {//安卓手机 || //winphone手机

                window.addEventListener('deviceorientation', function (event) {
                    // event.alpha; // 指南针方向（0°-360°）
                    // event.beta;   // 前后倾斜角度
                    // event.gamma; // 左右倾斜角度
                    // console.log("eventeventeventeventeventevent", event);
                    // console.log("webkitCompassHeading", event.webkitCompassHeading);
                    // console.log("webkitCompassAccuracy", event.webkitCompassAccuracy);
                    window.addEventListener('deviceorientation', throttle(deviceOrientationListener, 10, 30))
                });
            }
            else if (u.indexOf('iPhone') > -1) {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                if ('ondeviceorientation' in window) {
                                    window.addEventListener('deviceorientation', function (event) {
                                        // event.alpha; // 指南针方向（0°-360°）
                                        // event.beta;   // 前后倾斜角度
                                        // event.gamma; // 左右倾斜角度
                                        // console.log("eventeventeventeventeventevent", event);
                                        // console.log("webkitCompassHeading", event.webkitCompassHeading);
                                        // console.log("webkitCompassAccuracy", event.webkitCompassAccuracy);
                                        window.addEventListener('deviceorientation', throttle(deviceOrientationListener, 10, 30))
                                    }, true);
                                } else {
                                    console.error('Device orientation events are not supported in this browser.');
                                }


                            } else {
                                console.log('用户拒绝了陀螺仪访问权限');
                            }
                        })
                        .catch(console.error);
                } else {
                    console.log('浏览器不支持请求权限');
                }
            } else {
                return 'noAndoIos'
            }
        }

        //手机是否支持重力事件
        // if (window.DeviceOrientationEvent) {
        //     window.addEventListener('deviceorientation', throttle(deviceOrientationListener, 10, 30))

        // } else {
        //     alert("Sorry your browser doesn't support Device Orientation");
        // }
        //获取当前位置信息
        $(function () {
            var map = new BMap.Map("allmap");
            var point = new BMap.Point(104.06792346, 30.67994285);
            map.centerAndZoom(point, 16)
            var city = document.getElementById("position");
            var lat = document.getElementById("lat");
            var lng = document.getElementById("lng");
            var geoc = new BMap.Geocoder();
            function myFun(result) {
                var cityName = result.name;
                map.setCenter(cityName);
                city.innerHTML = cityName
                //alert("当前定位城市:"+cityName);
            }
            var myCity = new BMap.LocalCity();
            myCity.get(myFun);
            var geolocation = new BMap.Geolocation();
            geolocation.getCurrentPosition(function (r) {
                if (this.getStatus() == BMAP_STATUS_SUCCESS) {
                    var mk = new BMap.Marker(r.point);
                    map.addOverlay(mk);
                    map.panTo(r.point);
                    console.log("当前位置经度为:" + r.point.lng + "纬度为:" + r.point.lat);
                    lat.innerHTML = "纬度" + parseInt(r.point.lat) + '°' + parseInt((r.point.lat - parseInt(r.point.lat)) * 60) + "′" + parseInt(((r.point.lat - parseInt(r.point.lat)) * 60 - parseInt((r.point.lat - parseInt(r.point.lat)) * 60)) * 60) + "″";
                    lng.innerHTML = "经度" + parseInt(r.point.lng) + '°' + parseInt((r.point.lng - parseInt(r.point.lng)) * 60) + "′" + parseInt(((r.point.lng - parseInt(r.point.lng)) * 60 - parseInt((r.point.lng - parseInt(r.point.lng)) * 60)) * 60) + "″";

                } else {
                    console.log('无法定位到您的当前位置，导航失败，请手动输入您的当前位置！' + this.getStatus());
                }
            }, { enableHighAccuracy: true });
        });
    </script>
</body>

</html>