<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta http-equiv="Cache-control" content="no-cache">
  <title>Document</title>
  <!-- <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mui/3.7.1/css/mui.min.css"
    integrity="sha512-uclHupzhjfJ5Zbsweb6eEK3HyTUpSfiWq/+ORo20uQLZg3yI5Jg4iCZYOD5Q1Q5Ftm4FG9kCzwT82bVcNgFMRw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mui/3.7.1/js/mui.min.js"
    integrity="sha512-5LSZkoyayM01bXhnlp2T6+RLFc+dE4SIZofQMxy/ydOs3D35mgQYf6THIQrwIMmgoyjI+bqjuuj4fQcGLyJFYg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->

  <!-- <script src="https://metaverse-webar.oss-cn-hangzhou.aliyuncs.com/pro/8thwall.js"></script> -->
  <!-- <script src="E:/project/小程序JS库/8thwall.js"></script> -->
  <!-- <script src="E:/project/小程序JS库/permissions.js"></script> -->
  <script src="https://metaverse-webar.oss-cn-hangzhou.aliyuncs.com/pro/arILMLibrary.js"></script>

  <!-- <script src="https://metaverse-webar.oss-cn-hangzhou.aliyuncs.com/PluginRepositories/8thwall/Pro/8thwall.js"></script> -->
  <!-- <script src="https://metaverse-webar.oss-cn-hangzhou.aliyuncs.com/PluginRepositories/8thwall/Dev/8thwall.js"></script> -->
  <script src="https://metaverse-webar.oss-cn-hangzhou.aliyuncs.com/pro/8thwall.js"></script>
  <!-- <script
    src="https://metaverse-webar.oss-cn-hangzhou.aliyuncs.com/PluginRepositories/Permissions/Pro/permissions.js"></script> -->
  <script
    src="https://metaverse-webar.oss-cn-hangzhou.aliyuncs.com/PluginRepositories/Permissions/Dev/permissions.js"></script>
  <!-- <script src="./arILMLibrary.js"></script> -->

  <!-- 微信 SDK -->
  <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
  </style>
</head>

<body>
  <!-- <video width="500" height="500" autoplay class="video"></video> -->
  <canvas id="camerafeed"></canvas>
  <canvas id="unityCanvas"
    tyle="background: transparent; position: fixed; left: 0rem; top: 0rem; z-index: 801; width: 23.4375rem; height: 41.6875rem; cursor: default;"></canvas>
  <button onclick="checkAuthorization()">检查权限</button>
  <button onclick="close()">关闭摄像头</button>
  <button onclick="opens()" type="button">打开摄像头</button>

  <button onclick="startXR8()">开启XR8</button>
  <button onclick="xr8.xr8PauseOrResume(true)">Pause</button>
  <button onclick="xr8.xr8PauseOrResume(false)">Resume</button>
  <button onclick="XR8.stop()">Stop</button>
  <button onclick="XR8.run({ canvas: document.getElementById('camerafeed') });">Run</button>
  <button onclick="removeCameraPipelineModules()">移除相机管道</button>
  <button onclick="addCameraPipelineModules()">添加相机管道</button>
  <button onclick="recognition()">识别</button>
  <button onclick="canvasScreenshot()">截图</button>
  <button onclick="openAR()">开启AR识别</button>
  <button onclick="getQmap()">打开QQMap位置信息</button>
  <button onclick="closeQmap()">关闭QQMap位置信息</button>
  <button onclick="openWatchPosition()">打开GPS</button>
  <button onclick="closeWatchPosition()">关闭GPS</button>
  <button onclick="wxClick()">发起分享</button>

  <script>

    function wxClick() {
      wx.ready(function () {   //需在用户可能点击分享按钮前就先调用
        wx.updateAppMessageShareData({
          title: '分享标题', // 分享标题
          desc: '分享描述', // 分享描述
          link: 'https://minigame.shengydt.com/000893/index.html?token=889565eada5e57c3511a67546ebcad008f04307c01886d729815d51caed8b098&mapId=4208,4210,4205,4207,4209,4204,4206&isInScenic=true&debug=true', // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
          imgUrl: '', // 分享图标
          success: function () {
            // 设置成功
            console.log("成功!");
          }
        })
      });

      wx.previewImage({
        current: 'https://cdn.8thwall.com/web/img/loading/v1/settings-icon-ios.png', // 当前显示图片的http链接
        urls: ["https://cdn.8thwall.com/web/img/loading/v1/safari-icon.png", "https://cdn.8thwall.com/web/img/runtimeerror/v1/computer-voxel.png"] // 需要预览的图片http链接列表
      });
    }

    function startCompassListener(callback) {
      if (!window["DeviceOrientationEvent"]) {
        console.warn("DeviceOrientation API not available");
        return;
      }
      let absoluteListener = (e) => {
        if (!e.absolute || e.alpha == null || e.beta == null || e.gamma == null)
          return;
        let compass = -(e.alpha + e.beta * e.gamma / 90);
        compass -= Math.floor(compass / 360) * 360; // Wrap into range [0,360].
        window.removeEventListener("deviceorientation", webkitListener);
        callback(compass);
      };
      let webkitListener = (e) => {
        let compass = e.webkitCompassHeading;
        if (compass != null && !isNaN(compass)) {
          callback(compass);
          window.removeEventListener("deviceorientationabsolute", absoluteListener);
        }
      }

      function addListeners() {
        window.addEventListener("deviceorientationabsolute", absoluteListener);
        window.addEventListener("deviceorientation", webkitListener);
      }

      if (typeof (DeviceOrientationEvent["requestPermission"]) === "function") {
        DeviceOrientationEvent["requestPermission"]()
          .then(response => {
            if (response == "granted") {

              addListeners();
            } else
              console.warn("Permission for DeviceMotionEvent not granted");
          });
      } else
        addListeners();
    }

    function startWatchPosition(callback) {
      if ("geolocation" in navigator) {
        // 支持Geolocation
        navigator.geolocation.watchPosition(function (position) {
          // 成功获取位置信息
          const latitude = position.coords.latitude; // 纬度
          const longitude = position.coords.longitude; // 经度
          const altitude = position.coords.altitude; // 高度
          const speed = position.coords.speed; // 速度
          const heading = position.coords.heading; // 方向
          callback(position)
        }, function (error) {
          // 获取位置信息失败
          console.error("获取位置信息失败：" + error.message);
        }, { enableHighAccuracy: true, maximumAge: 0 });
      } else {
        // 不支持Geolocation
        console.error("浏览器不支持Geolocation API");
      }
    }

    function checkAuthorization() {
      permissionsObj.checkAuthorization((authorizationResult) => {
        console.log("authorizationResult", authorizationResult);
      })
    }

    function opens() {
      permissionsObj.onStartCamera();
    }

    function close() {
      permissionsObj.onCloseCamera();
    }

    function removeCameraPipelineModules() {
      if (XR8.isInitialized()) {
        xr8.removeImmersalPipelineModules();
        console.log(XR8.version());
      }
    }

    function addCameraPipelineModules() {
      if (XR8.isInitialized()) {
        xr8.injectImmersalPipelineModule();
        console.log(XR8.version())
      }
    }

    function recognition() {
      if (XR8.isInitialized()) {
        xr8.recognition((success, position, rotation, scale) => {
          if (success) {
            console.log("recognition：", position, rotation, scale);
          }
        });
        console.log(XR8.version())
      }
    }

    function canvasScreenshot() {
      if (XR8.isInitialized()) {
        xr8.canvasScreenshot(({ xr8Image, xr8Imagedata, screenshotPicture }) => {
          console.log({ xr8Image, xr8Imagedata, screenshotPicture });
        })
        console.log(XR8.version())
      }
    }

    function openAR() {
      let arLib = new ArILM.Init({
        debugger: true,
      }, () => {

      })
    }

    function getEnvironmentInfo(environment = "pre") {
      fetch(`https://metaoss-webar.shengydt.com/${environment}/UnityLayer/${location.pathname.split('/')[1]}/Environment.json`).then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      }).then(([{ environment, status }]) => {
        console.log(data);
      }).catch(error => {
        console.error('Fetch error:', error);
      });
    }

    function getQmap(position) {
      permissionsObj._startQMapWatchPosition((position) => {
        console.log("getQmapgetQmapgetQmap", position);
      })
    }

    function closeQmap() {
      permissionsObj._stopQMapWatchPosition(({ success }) => {
        console.log("关闭QMap", success);
      })
    }

    function openWatchPosition() {
      permissionsObj._startWatchPosition((position) => {
        console.log("openWatchPosition", position);
        permissionsObj._permissions.geolocation.successResults(position)
      });
    }

    function closeWatchPosition() {
      permissionsObj._stopWatchPosition();
      console.log("关闭closeWatchPosition");
    }

    // window.onload = () => {
    // new window.VConsole();
    // console.log("permissions", new permissions());
    let permissionsObj;
    let xr8 = null;

    permissionsObj = new permissions.init({
      unityInstance: {        // *SendMessage Target
        target: {},

        sendMessage: {
          gameObject: "UnityJsBridge",
          methodName: "JsToUnityTrigger",
          timer: 1000,
        }
      },
      permissions: {
        deviceorientation: {
          enabled: false,
          successResults: (response) => { }
        },
        geolocation: {
          enabled: true,
          successResults: (response) => {
            console.log("geolocationgeolocation", response);
          }
        },
        mediaDevices: {
          enabled: false,
          canvas: "cameraCanvas",
          successResults: (response) => { },
          video: {
            width: 1280,
            height: 720,
            // frameRate: { ideal: 10, max: 15 },
            facingMode: { exact: "environment" },
          },
          audio: false,
        }
      },
      deviceAuthorization: {
        confirm: {
          message: "《AR导航》需要访问您的摄像头、运动与方向，需要您的授权！",
          title: "提示",
          btnValue: ['取消', '允许'],
          callback: ({ index, value: { authorization, btnName } }) => { },
          type: "div"
        },
        alert: {
          message: "请使用安卓或苹果设备访问！",
          title: "提示",
          btnValue: ["确定"],
          callback: ({ index, value: { inform, btnName } }) => { },
          type: "div"
        }
      },
      errors: ({ index, value: { error, btnName = "" } }) => {
        console.log("errors", error,);
      },
      debugger: false,
    }, ({ success }) => {
      if (success) {
        xr8thWall.Init.loadNeedJsOrCSS(
          [
            // {
            //   // 8thWall Web - Replace the app key here with your own app key
            //   src: `https://apps.8thwall.com/xrweb?appKey=1JQhYDLd1E7p8jnKth96BNIyfd0zRIqfMejyXzj0shJjcFMiSIybdWPFDzGq95nagyx2ri`,
            //   type: 1,
            // },
            {
              src: "https://metaoss-webar.shengydt.com/PluginRepositories/Public/three.min.js",
              type: 1,
            },
            {
              src: "https://metaoss-webar.shengydt.com/PluginRepositories/Public/UPNG.js",
              type: 1,
            },
            {
              src: "https://metaoss-webar.shengydt.com/PluginRepositories/Public/pako.min.js",
              type: 1,
            },
            {
              // XR Extras - provides utilities like load screen, almost there, and error handling.
              //  See github.com/8thwall/web/tree/master/xrextras
              // src: "https://metaoss-webar.shengydt.com/PluginRepositories/8thwall/xrextras.js",
              src: "https://cdn.8thwall.com/web/xrextras/xrextras.js",
              type: 1,
            },
            {
              // Coaching Overlay 
              // src: "https://metaoss-webar.shengydt.com/PluginRepositories/8thwall/coaching-overlay.js",
              src: "https://cdn.8thwall.com/web/coaching-overlay/coaching-overlay.js",
              type: 1,
            },
            {
              src: "https://metaoss-webar.shengydt.com/PluginRepositories/Public/mui.min.js",
              type: 1,
            },
            {
              src: "https://metaoss-webar.shengydt.com/PluginRepositories/Public/mui.min.css",
              type: 2,
            },
            {
              src: "https://metaoss-webar.shengydt.com/PluginRepositories/Public/jquery-3.4.1.min.js",
              type: 1,
            },
            {
              src: "https://metaoss-webar.shengydt.com/PluginRepositories/Public/vconsole.min.js",
              type: 1,
            },
            {
              src: "https://metaoss-webar.shengydt.com/PluginRepositories/8thwall/8thwall.css",
              type: 2,
            }
          ],
          () => {
            console.log("Preload complete");
            let audio = new Audio(`https://metaverse-ar-beta.oss-cn-hangzhou.aliyuncs.com/HotData/WenDaoYuan/WenDaoYuanMiniProgram/POIData/%E6%A5%A0%E6%9C%A8%E5%8E%85%E8%AE%B2%E8%A7%A3%E5%86%85%E5%AE%B9.mp3`);
            audio.preload = true;
            audio.loop = true;
            audio.playsinline = true;
            // audio.muted = true;
            audio.webkitPlaysinline = true;
            audio.play();
          })

        // setInterval(() => {
        //   unityInstance.SendMessage("UnityJsBridge", "JsToUnityTrigger", JSON.stringify(
        //     permissionsObj._compassAndLocation
        //   ));
        // }, 1000);
      }
    });

    function startXR8() {
      // start 8thwall
      xr8 = new xr8thWall.Init({
        appKey: "1JQhYDLd1E7p8jnKth96BNIyfd0zRIqfMejyXzj0shJjcFMiSIybdWPFDzGq95nagyx2ri",
        xrControllerConfigure: {},
        timeoutConfig: {
          secondaryWaitingStartTime: 5,
          secondaryWaitingOverTime: 10,
          first: { message: "1呀，网络似乎被UFO抢走了，极其不稳定", title: "提示", btnValue: ["重新进入", "继续等待"] },
          twice: { message: "2似乎并没有将网络获取权，从UFO手中抢过来，需要重新进入！", title: "提示", btnValue: ["确定"] },
        },
        cameraConfig: {
          enabled: true,
          canvas: "camerafeed",
          onUpdate: ({ cameraPosition, cameraRotation }) => {
            console.log("onUpdate", cameraPosition, cameraRotation);
            // unityInstance.SendMessage('UnityJsBridge', 'SyncCameraTransform', JSON.stringify({ Position: cameraPosition, Rotation: cameraRotation }));
          }
        },
        debugger: true,
        unityConfig: {
          canvas: "unityCanvas",
        },
      }, ({ success, errors = null }) => {
        if (success) {
          console.log("xr8thWall", success, errors, XR8, xr8);
          // window.unityInstance.SendMessage('UnityJsBridge', 'JsToUnityTrigger', JSON.stringify([{ "method": "xr8Initialize", arguments: { "success": "true" } }]));
          // xr8.recognition(({success, position, rotation, scale, data}) => {//识别、
          //   if (success) {
          //     window.unityInstance.SendMessage('UnityJsBridge', 'JsToUnityTrigger', JSON.stringify([{ "method": "mapRecognitionSuccess", arguments: { "mapID": String(data.map) } }]));
          //     window.unityInstance.SendMessage('UnityJsBridge', 'SyncARSpaceTransform', JSON.stringify({ Position: position, Rotation: { x: rotation['_x'], y: rotation['_y'], z: rotation['_z'], w: rotation['_w'] } }));
          //     console.log("recognition：", position, rotation, scale, data);
          //   }
          // });
        } else {
          console.log("message", errors);
        }
      }, ({ message }) => {
        console.log("message", message);
      })
    }



    // AMap.plugin('AMap.Geolocation', function () {
    //   var geolocation = new AMap.Geolocation({
    //     enableHighAccuracy: true, // 启用高精度定位
    //     timeout: 10000, // 超时时间
    //   });

    //   console.log("geolocation", geolocation);

    //   // geolocation.getCurrentPosition(function (status, result) {
    //   //   if (status === 'complete') {
    //   //     // 获取当前位置的经纬度
    //   //     var lng = result.position.lng;
    //   //     var lat = result.position.lat;
    //   //     console.log('当前位置经度：' + lng + '，纬度：' + lat);
    //   //   } else {
    //   //     console.error('定位失败：' + result.info);
    //   //   }
    //   // });

    //   geolocation.watchPosition(function (status, result) {
    //     console.log("watchPosition", status, result);
    //     if (status === 'complete') {
    //       // 获取实时位置的经纬度
    //       var lng = result.position.lng;
    //       var lat = result.position.lat;
    //       console.log('实时位置经度：' + lng + '，纬度：' + lat, 'result:', result);
    //     } else {
    //       console.error('定位失败：' + result.info);
    //     }
    //   });
    // });


    // var u = navigator.userAgent;
    // if (u.indexOf('Android') > -1 || u.indexOf('Linux') > -1 || u.indexOf('Windows Phone') > -1) {
    //   startCompassListener(res => {
    //     if (res) {
    //       console.log("startCompassListener", res);
    //     }
    //   })
    //   startWatchPosition(res => {
    //     if (res) {
    //       console.log("startWatchPosition", res);
    //     }
    //   })
    // } else if (u.indexOf('iPhone') > -1) {
    //   mui.confirm(`"${window.location.href}"想要访问运动与方向`, '提示', ['取消', '允许'], (res) => {
    //     console.log("IOS mui", res);
    //     startCompassListener(res => {
    //       if (res) {
    //         console.log("IOS startCompassListener", res);
    //       }
    //     })
    //     startWatchPosition(position => {
    //       if (position) {
    //         let latitude = position.coords.latitude; // 纬度
    //         let longitude = position.coords.longitude; // 经度
    //         let altitude = position.coords.altitude; // 高度
    //         let speed = position.coords.speed; // 速度
    //         let heading = position.coords.heading; // 方向
    //         console.log("IOS startWatchPosition", `latitude：${latitude},longitude:${longitude}`);
    //       }
    //     })
    //   }, 'div')
    // } else {
    //   return 'noAndoIos'
    // }

    // }

    let cachedResult;

    document.onload = () => {
      startXR8();
    }

    fetch(`https://meta-gateway.shengydt.com/api/admin/wechat/config?url=${encodeURIComponent('https://minigame.shengydt.com/000893/index.html?token=889565eada5e57c3511a67546ebcad008f04307c01886d729815d51caed8b098&mapId=4208,4210,4205,4207,4209,4204,4206&isInScenic=true&debug=true')}`).then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    }).then((data) => {
      wx.config({
        debug: false,
        appId: data.data.appId,
        timestamp: data.data.timestamp,
        nonceStr: data.data.nonceStr,
        signature: data.data.signature,
        jsApiList: data.data.jsApiList,
        appId: "wx9aa33c63d524f541",
        timestamp: "1696219424",
        nonceStr: "b0e510a01ab1407ab2309b9fecfb73a7",
        signature: "3138d44e9d07d9c02aa916fec272efdd217c9c1b",
        jsApiList: [
          'onMenuShareTimeline',						//分享到微信朋友圈
          'onMenuShareAppMessage',					//分享给微信朋友
          'onMenuShareQQ',							//分享到QQ
          'onMenuShareQZone',							//分享到QQ空间
          "updateAppMessageShareData",  //分享到微信及QQ（新接口）
          "updateTimelineShareData",    //分享到朋友圈”及“分享到QQ空间（新接口）
          "downloadImage",
          "scanQRCode"
        ]
      });
    }).catch(error => {
      console.error('Fetch error:', error);
    });

  </script>
</body>

</html>