<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mui/3.7.1/css/mui.min.css"
    integrity="sha512-uclHupzhjfJ5Zbsweb6eEK3HyTUpSfiWq/+ORo20uQLZg3yI5Jg4iCZYOD5Q1Q5Ftm4FG9kCzwT82bVcNgFMRw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mui/3.7.1/js/mui.min.js"
    integrity="sha512-5LSZkoyayM01bXhnlp2T6+RLFc+dE4SIZofQMxy/ydOs3D35mgQYf6THIQrwIMmgoyjI+bqjuuj4fQcGLyJFYg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    .open {
      width: 100px;
      height: 100px;
    }
  </style>
</head>

<body>
  <script>

    function startCompassListener(callback) {
      if (!window["DeviceOrientationEvent"]) {
        console.warn("DeviceOrientation API not available");
        return;
      }
      let absoluteListener = (e) => {
        if (!e.absolute || e.alpha == null || e.beta == null || e.gamma == null)
          return;
        let compass = -(e.alpha + e.beta * e.gamma / 90);
        compass -= Math.floor(compass / 360) * 360; // Wrap into range [0,360].
        window.removeEventListener("deviceorientation", webkitListener);
        callback(compass);
      };
      let webkitListener = (e) => {
        let compass = e.webkitCompassHeading;
        if (compass != null && !isNaN(compass)) {
          callback(compass);
          window.removeEventListener("deviceorientationabsolute", absoluteListener);
        }
      }

      function addListeners() {
        window.addEventListener("deviceorientationabsolute", absoluteListener);
        window.addEventListener("deviceorientation", webkitListener);
      }

      if (typeof (DeviceOrientationEvent["requestPermission"]) === "function") {
        DeviceOrientationEvent["requestPermission"]()
          .then(response => {
            if (response == "granted") {
              addListeners();
            } else
              console.warn("Permission for DeviceMotionEvent not granted");
          });
      } else
        addListeners();
    }

    function startWatchPosition(callback) {
      if ("geolocation" in navigator) {
        // 支持Geolocation
        navigator.geolocation.watchPosition(function (position) {
          // 成功获取位置信息
          const latitude = position.coords.latitude; // 纬度
          const longitude = position.coords.longitude; // 经度
          const altitude = position.coords.altitude; // 高度
          const speed = position.coords.speed; // 速度
          const heading = position.coords.heading; // 方向
          callback(position)
        }, function (error) {
          // 获取位置信息失败
          console.error("获取位置信息失败：" + error.message);
        });
      } else {
        // 不支持Geolocation
        console.error("浏览器不支持Geolocation API");
      }
    }

    window.onload = () => {
      new window.VConsole();
      var u = navigator.userAgent;
      if (u.indexOf('Android') > -1 || u.indexOf('Linux') > -1 || u.indexOf('Windows Phone') > -1) {
        startCompassListener(res => {
          if (res) {
            console.log("startCompassListener", res);
          }
        })
        startWatchPosition(res => {
          if (res) {
            console.log("startWatchPosition", res);
          }
        })
      } else if (u.indexOf('iPhone') > -1) {
        mui.confirm(`"${window.location.href}"想要访问运动与方向`, '提示', ['取消', '允许'], (res) => {
          console.log("IOS mui", res);
          startCompassListener(res => {
            if (res) {
              console.log("IOS startCompassListener", res);
            }
          })
          startWatchPosition(res => {
            if (position) {
              let latitude = position.coords.latitude; // 纬度
              let longitude = position.coords.longitude; // 经度
              let altitude = position.coords.altitude; // 高度
              let speed = position.coords.speed; // 速度
              let heading = position.coords.heading; // 方向
              console.log("IOS startWatchPosition", `latitude：${latitude},longitude:${longitude}`);
            }
          })
        }, 'div')
      } else {
        return 'noAndoIos'
      }
    }
  </script>
</body>

</html>